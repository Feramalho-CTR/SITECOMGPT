<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sala de Aula</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        #btnVoltar {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 8px 18px;
            background-color: #2b2b45;
            color: #00f0ff;
            border: 1px solid #00f0ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 0 5px rgba(0, 240, 255, 0.5);
            z-index: 100;
        }

        #btnVoltar:hover {
            background-color: #00f0ff;
            color: #1a1a2e;
            box-shadow: 0 0 10px #00f0ff;
        }
        
        header {
            position: absolute;
            top: 60px;
            left: 20px;
            text-align: left;
            margin: 0;
            z-index: 90;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: #f0f0f0;
            text-shadow: 0 0 5px #00f0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        header p {
            margin: 5px 0 0;
            font-size: 1.1rem;
            color: #8899a6;
            font-style: italic;
        }
        
        #top-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            margin-top: 100px;
            width: 100%;
            max-width: 540px;
            z-index: 80;
        }
        
        #btnMusica {
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4a4a6e;
            color: #00f0ff;
            border: 1px solid #00f0ff;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 240, 255, 0.5);
        }
        
        #btnMusica:hover {
            background-color: #00f0ff;
            color: #1a1a2e;
        }

        #sortearBtn {
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(45deg, #00f0ff, #00e676);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 240, 255, 0.4);
            transition: all 0.3s ease;
            text-shadow: none;
            flex-grow: 1;
        }

        #sortearBtn:hover {
            background: linear-gradient(45deg, #00e676, #00f0ff);
            box-shadow: 0 6px 20px rgba(0, 240, 255, 0.6);
            transform: translateY(-2px);
        }

        #btnEncerrarSala {
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(217, 83, 79, 0.4);
            transition: all 0.3s ease;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
            flex-grow: 1;
        }

        #btnEncerrarSala:hover {
            background-color: #c9302c;
            box-shadow: 0 6px 20px rgba(217, 83, 79, 0.6);
            transform: translateY(-2px);
        }

        .classroom {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            grid-gap: 15px;
            background: #1f2838;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 540px;
            border: 1px solid #3d4a5c;
            flex-grow: 1;
            margin-top: 0;
        }
        
        .desk {
            background: #2b2b45;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: default;
            user-select: none;
            transition: all 0.3s ease;
            border: 1px solid #3d4a5c;
        }
        .desk.sorteando {
            box-shadow: 0 0 10px 5px rgba(255, 255, 0, 0.8), 0 0 20px 10px rgba(255, 255, 0, 0.4);
            transform: scale(1.05);
        }
        .desk:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.7);
        }

        .desk.sorteado {
            background-color: #004d40;
            border-color: #00e676;
        }

        .desk.piscar {
            animation: piscarMesa 0.8s infinite alternate;
        }

        @keyframes piscarMesa {
            from {
                box-shadow: 0 0 15px #ffd700, 0 0 5px #ffeb3b;
            }
            to {
                box-shadow: 0 0 20px #00e676, 0 0 8px #00e676;
            }
        }
        
        .table {
            width: 100%;
            height: 35px;
            background: #00f0ff;
            border-radius: 6px;
            margin-bottom: 6px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            opacity: 0.6;
        }

        .chair {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #4a4a6e;
            border-radius: 8px;
            border: 2px solid #00f0ff;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #f0f0f0 !important;
            text-align: center;
            padding: 2px;
            transition: color 0.3s ease;
            text-shadow: 1px 1px 2px #000;
        }

        #encerrarSalaModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #encerrarSalaModalContent {
            background-color: #1f2838;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 450px;
            border: 1px solid #3d4a5c;
        }
        #encerrarSalaModalContent p {
            font-size: 1.2em;
            color: #f0f0f0;
            margin-bottom: 25px;
            text-shadow: 0 0 5px #00f0ff;
        }
        #encerrarSalaModal button {
            margin: 5px;
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            transition: all 0.2s ease;
            font-weight: bold;
        }
        #btnConfirmarEncerrar {
            background-color: #d9534f;
            color: white;
        }
        #btnConfirmarEncerrar:hover {
            background-color: #c9302c;
        }
        #btnCancelarEncerrar {
            background-color: #3d4a5c;
            color: #f0f0f0;
            border: 1px solid #00f0ff;
        }
        #btnCancelarEncerrar:hover {
            background-color: #4a5970;
        }
        #cardAlunoSorteado {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2b2b45;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
            border: 2px solid #ffd700;
            animation: pulse 1.5s infinite;
            display: none;
            text-shadow: 0 0 5px #ffd700;
        }
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            }
        }
        
        #cardMusica {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2b2b45;
            border: 1px solid #00f0ff;
            border-radius: 8px;
            padding: 10px 15px;
            color: #e0e0e0;
            font-size: 0.9em;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            transition: opacity 0.3s ease;
        }

        #cardMusica img {
            height: 24px;
            width: 24px;
        }
        
        #youtube-player-container {
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
            top: -100px;
            left: -100px;
        }

        /* --- Responsividade para Dispositivos M√≥veis --- */
        @media (max-width: 600px) {
            body {
                padding: 15px 10px 120px 10px;
            }

            header {
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                text-align: center;
                width: 100%;
            }
            header h1 {
                font-size: 1.5rem;
            }
            header p {
                font-size: 0.9rem;
            }

            .classroom {
                grid-template-columns: repeat(4, 1fr);
                grid-gap: 10px;
                padding: 15px;
            }

            #top-controls {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 25px;
                margin-top: 150px;
            }

            #sortearBtn,
            #btnEncerrarSala {
                font-size: 14px;
                padding: 12px 18px;
                width: 100%;
            }
            
            #cardAlunoSorteado {
                width: 90%;
                max-width: 350px;
                font-size: 1.5em;
                text-align: center;
            }
            
            #cardMusica {
                top: 15px;
                right: 15px;
                font-size: 0.8em;
                padding: 8px 12px;
                gap: 8px;
            }

            #cardMusica img {
                height: 20px;
                width: 20px;
            }
        }
    </style>
</head>

<body>
    <button id="btnVoltar" onclick="location.href='index.html'">‚Üê Voltar ao In√≠cio</button>

    <div id="cardMusica">
        <span>üéµ M√∫sica: <span id="musicaTitulo"></span></span>
    </div>

    <div id="top-controls">
        <button id="sortearBtn" style="display:none;">Sortear Aluno</button>
        <button id="btnEncerrarSala" style="display:none;">Encerrar Sala</button>
        <button id="btnMusica" style="display:none;">üéµ Tocar M√∫sica</button>
    </div>

    <header>
        <h1 id="roomName">Sala: --</h1>
        <p id="roomCode">C√≥digo da Sala: --</p>
    </header>

    <div class="classroom" id="classroom">
    </div>

    <div id="encerrarSalaModal">
        <div id="encerrarSalaModalContent">
            <p>Todos os alunos foram sorteados. Deseja encerrar a sala?</p>
            <button id="btnConfirmarEncerrar">Sim, encerrar a sala</button>
            <button id="btnCancelarEncerrar">N√£o, continuar</button>
        </div>
    </div>

    <div id="cardAlunoSorteado"></div>

    <audio id="somContagem" src="./sons/bell-sound-370341.mp3" preload="auto"></audio>
    <audio id="somFinal" src="./sons/winning-218995.mp3" preload="auto"></audio>
    
    <div id="youtube-player-container">
        <div id="youtube-player"></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>

<script type="module">
    import { db } from './firebase-config.js';
    import { ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get('codigo') || '----';
    const tipo = params.get('tipo') || 'aluno';

    let salaKey = null;
    let alunos = [];
    let alunosSorteados = {};
    let ultimoSorteado = null;
    let musicaStatusFirebase = 'pausada';
    let animacaoEmAndamento = false;

    const somContagem = document.getElementById('somContagem');
    const somFinal = document.getElementById('somFinal');
    
    const cardMusica = document.getElementById('cardMusica');
    const musicaTitulo = document.getElementById('musicaTitulo');
    const btnMusica = document.getElementById('btnMusica');
    let youtubePlayer;
    
    const youtubeVideoId = '36YnV9STBqc';

    // -----------------------------------------------------------
    // L√ìGICA DA API DO YOUTUBE
    // -----------------------------------------------------------
    window.onYouTubeIframeAPIReady = function() {
        youtubePlayer = new YT.Player('youtube-player', {
            height: '0', 
            width: '0',
            videoId: youtubeVideoId,
            playerVars: {
                'autoplay': 0,
                'controls': 0,
                'loop': 1,
                'modestbranding': 1,
                'playlist': youtubeVideoId,
            },
            events: {
                'onReady': onPlayerReady
            }
        });
    };

    function onPlayerReady(event) {
        try {
            const videoData = event.target.getVideoData();
            musicaTitulo.textContent = videoData && videoData.title ? videoData.title : 'M√∫sica de Fundo';
        } catch (e) {
            musicaTitulo.textContent = 'M√∫sica de Fundo';
            console.error("Erro ao obter o t√≠tulo do v√≠deo:", e);
        }
        event.target.setVolume(30);
    }
    
    function pausarMusicaFundo() {
        if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function' && youtubePlayer.getPlayerState() === YT.PlayerState.PLAYING) {
            youtubePlayer.pauseVideo();
            cardMusica.style.opacity = '0.5';
            if (tipo === 'professor') {
                btnMusica.textContent = 'üéµ Tocar M√∫sica';
            }
        }
    }

    function tocarMusicaFundo() {
        if (youtubePlayer && typeof youtubePlayer.playVideo === 'function' && youtubePlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
            youtubePlayer.playVideo().catch(e => console.error("Erro ao tocar a m√∫sica:", e));
            cardMusica.style.opacity = '1';
            if (tipo === 'professor') {
                btnMusica.textContent = 'üéµ Pausar M√∫sica';
            }
        }
    }
    // -----------------------------------------------------------
    // FIM DA L√ìGICA DA API DO YOUTUBE
    // -----------------------------------------------------------

    function buscarAlunos(sala) {
        const arr = sala && sala.alunos ? sala.alunos.slice(0, 30) : [];
        while (arr.length < 30) arr.push('');
        return arr;
    }

    function atualizarListaDeAlunos(alunos) {
        const classroom = document.getElementById('classroom');
        classroom.innerHTML = '';

        for (let i = 0; i < 30; i++) {
            const desk = document.createElement('div');
            desk.classList.add('desk');

            const table = document.createElement('div');
            table.classList.add('table');

            const chair = document.createElement('div');
            chair.classList.add('chair');

            if (alunos[i]) {
                chair.textContent = alunos[i];
                chair.style.color = '#f0f0f0';

                if (alunosSorteados[alunos[i]]) {
                    desk.classList.add('sorteado');
                }
                
            } else {
                chair.textContent = i + 1;
                chair.style.color = '#8899a6';
            }

            desk.appendChild(table);
            desk.appendChild(chair);
            classroom.appendChild(desk);
        }
    }

    function atualizarHeader(sala) {
        const roomName = document.getElementById('roomName');
        const roomCodeEl = document.getElementById('roomCode');

        if (sala) {
            roomName.textContent = `Sala: ${sala.nome || '--'}`;
            roomCodeEl.textContent = `C√≥digo: ${sala.codigo || '--'}`;
        } else {
            roomName.textContent = 'Sala n√£o encontrada';
            roomCodeEl.textContent = 'C√≥digo: --';
        }
    }

    let animationSteps = 25;
    let currentStep = 0;
    let finalSorteado = null;
    let desksDisponiveis = [];

    async function iniciarAnimacaoSorteio(alunosDisponiveis) {
        if (alunosDisponiveis.length === 0) {
            exibirModalEncerrarSala();
            return;
        }
        
        pausarMusicaFundo();

        sortearBtn.disabled = true;
        animacaoEmAndamento = true;

        const allDesks = document.querySelectorAll('.desk');
        desksDisponiveis = Array.from(allDesks).filter(desk => {
            const chairText = desk.querySelector('.chair').textContent;
            return alunosDisponiveis.includes(chairText);
        });

        finalSorteado = alunosDisponiveis[Math.floor(Math.random() * alunosDisponiveis.length)];
        currentStep = 0;
        executarPassoAnimacao();
    }

    function executarPassoAnimacao() {
        if (!animacaoEmAndamento || !salaKey) return;

        if (currentStep >= animationSteps) {
            finalizarSorteioFirebase(finalSorteado);
            return;
        }

        const randomIndex = Math.floor(Math.random() * desksDisponiveis.length);
        const deskToHighlight = desksDisponiveis[randomIndex];
        const alunoToHighlight = deskToHighlight.querySelector('.chair').textContent;
        
        update(ref(db, `salas/${salaKey}`), { sorteando: alunoToHighlight });

        somContagem.currentTime = 0;
        somContagem.play().catch(e => console.error("Erro ao tocar o som de contagem:", e));

        currentStep++;
        const progress = currentStep / animationSteps;
        const delay = 30 + (progress * progress * 200);

        setTimeout(executarPassoAnimacao, delay);
    }

    async function finalizarSorteioFirebase(alunoSorteado) {
        somContagem.pause();
        somContagem.currentTime = 0;
        somFinal.volume = 0.5;
        somFinal.play().catch(e => console.error("Erro ao tocar o som final:", e));

        if (salaKey) {
            await update(ref(db, `salas/${salaKey}`), {
                alunosSorteados: { ...alunosSorteados, [alunoSorteado]: true },
                ultimoSorteado: alunoSorteado,
                sorteio: alunoSorteado,
                sorteando: null
            });
        }

        setTimeout(() => {
            if (sortearBtn) sortearBtn.disabled = false;
            if (salaKey) {
                 update(ref(db, `salas/${salaKey}`), { ultimoSorteado: null, sorteio: null });
            }
            animacaoEmAndamento = false;
        }, 5000);
    }

    function exibirCardAlunoSorteado(alunoSorteado) {
        let card = document.getElementById('cardAlunoSorteado');
        if (card) {
            card.textContent = `Aluno Sorteado: ${alunoSorteado}`;
            card.style.display = 'block';
        }
    }

    function ocultarCardAlunoSorteado() {
        const card = document.getElementById('cardAlunoSorteado');
        if (card) {
            card.style.display = 'none';
        }
    }

    function exibirModalEncerrarSala() {
        const modal = document.getElementById('encerrarSalaModal');
        modal.style.display = 'flex';
    }

    function ocultarModalEncerrarSala() {
        const modal = document.getElementById('encerrarSalaModal');
        modal.style.display = 'none';
    }

    const sortearBtn = document.getElementById('sortearBtn');
    const btnEncerrarSala = document.getElementById('btnEncerrarSala');
    const btnConfirmarEncerrar = document.getElementById('btnConfirmarEncerrar');
    const btnCancelarEncerrar = document.getElementById('btnCancelarEncerrar');

    if (tipo === 'professor') {
        sortearBtn.style.display = 'inline-block';
        btnEncerrarSala.style.display = 'inline-block';
        btnMusica.style.display = 'inline-block';

        sortearBtn.onclick = sortearAluno;
        btnEncerrarSala.onclick = () => exibirModalEncerrarSala();
        
        btnMusica.onclick = () => {
            if (!salaKey) return;
            const novoStatus = musicaStatusFirebase === 'tocando' ? 'pausada' : 'tocando';
            if (novoStatus === 'tocando') {
                tocarMusicaFundo();
            } else {
                pausarMusicaFundo();
            }
            update(ref(db, `salas/${salaKey}`), { musicaStatus: novoStatus });
        };

        btnConfirmarEncerrar.onclick = async () => {
            if (!salaKey) return;
            try {
                await remove(ref(db, `salas/${salaKey}`));
                alert('Sala encerrada com sucesso!');
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Erro ao encerrar a sala: ", error);
                alert('Erro ao encerrar a sala.');
            }
        };

        btnCancelarEncerrar.onclick = () => ocultarModalEncerrarSala();

        async function sortearAluno() {
            if (!salaKey) {
                alert("A sala n√£o foi encontrada. N√£o √© poss√≠vel sortear.");
                return;
            }
            const totalAlunosNaSala = alunos.filter(aluno => aluno).length;
            if (totalAlunosNaSala === 0) {
                alert("N√£o h√° alunos na sala para sortear.");
                return;
            }

            let alunosDisponiveis = alunos.filter(aluno => aluno && !alunosSorteados[aluno]);

            if (alunosDisponiveis.length === 0) {
                exibirModalEncerrarSala();
                return;
            }

            iniciarAnimacaoSorteio(alunosDisponiveis);
        }

    } else {
        sortearBtn.style.display = 'none';
        btnEncerrarSala.style.display = 'none';
        btnMusica.style.display = 'none';
    }

    function init() {
        cardMusica.style.display = 'flex';

        const salasRef = ref(db, 'salas');
        onValue(salasRef, (snapshot) => {
            let salaEncontrada = null;
            let chaveEncontrada = null;
            snapshot.forEach((childSnapshot) => {
                const sala = childSnapshot.val();
                if (sala.codigo === roomCode) {
                    salaEncontrada = sala;
                    chaveEncontrada = childSnapshot.key;
                }
            });

            salaKey = chaveEncontrada;

            if (salaEncontrada) {
                atualizarHeader(salaEncontrada);
                alunos = buscarAlunos(salaEncontrada);
                alunosSorteados = salaEncontrada.alunosSorteados || {};
                
                // Salva o √∫ltimo sorteado antes de atualizar a lista de alunos
                const ultimoSorteadoAnterior = ultimoSorteado;
                ultimoSorteado = salaEncontrada.ultimoSorteado || null;
                
                atualizarListaDeAlunos(alunos);

                // --- L√≥gica para o card de piscar do √∫ltimo sorteado ---
                const desks = document.querySelectorAll('.desk');
                // Remove a classe de piscar de todas as mesas
                desks.forEach(desk => desk.classList.remove('piscar'));
                
                // Se houver um √∫ltimo sorteado, adiciona a classe de piscar na mesa correspondente
                if (ultimoSorteado && !animacaoEmAndamento) {
                    const deskDoSorteado = Array.from(desks).find(d => d.querySelector('.chair').textContent === ultimoSorteado);
                    if (deskDoSorteado) {
                        deskDoSorteado.classList.add('piscar');
                    }
                }
                // --- Fim da l√≥gica do card de piscar ---

                // L√≥gica para sincronizar m√∫sica
                musicaStatusFirebase = salaEncontrada.musicaStatus || 'pausada';
                if (musicaStatusFirebase === 'tocando') {
                    tocarMusicaFundo();
                } else {
                    pausarMusicaFundo();
                }
                
                const sorteandoAluno = salaEncontrada.sorteando || null;
                desks.forEach(desk => desk.classList.remove('sorteando'));

                if (sorteandoAluno) {
                    const deskSorteando = Array.from(desks).find(d => d.querySelector('.chair').textContent === sorteandoAluno);
                    if (deskSorteando) {
                        deskSorteando.classList.add('sorteando');
                        if (tipo !== 'professor') {
                            somContagem.currentTime = 0;
                            somContagem.play().catch(e => console.error("Erro ao tocar o som de contagem:", e));
                        }
                        pausarMusicaFundo();
                    }
                }
                
                if (salaEncontrada.sorteio) {
                    exibirCardAlunoSorteado(salaEncontrada.sorteio);
                    if (tipo !== 'professor') {
                        somFinal.volume = 0.5;
                        somFinal.play().catch(e => console.error("Erro ao tocar o som final:", e));
                    }
                    pausarMusicaFundo();
                } else {
                    ocultarCardAlunoSorteado();
                    if (!sorteandoAluno && musicaStatusFirebase === 'tocando') {
                        tocarMusicaFundo();
                    }
                }
            } else {
                salaKey = null;
                atualizarHeader(null);
                alunos = buscarAlunos({});
                alunosSorteados = {};
                ultimoSorteado = null;
                atualizarListaDeAlunos(alunos);
                ocultarCardAlunoSorteado();
            }
        });
    }

    init();
</script>
</script>
</body>

</html>